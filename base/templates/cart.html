{% extends 'base.html' %}
{% block title %}
  Cart
{% endblock %}
{% block content %}
  {% include 'partials/header.html' %}

  <div>
    <div class="container">
      <div class="row pt-3">
        <div class="col">
          <nav aria-label="breadcrumb" class="rounded-3 p-3">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item">
                <a href="/">Home</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">Cart</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>

    <div class="container mx-auto p-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Cart Items -->
        <div class="col-span-2">
          <div class="bg-white shadow-md rounded-lg p-4">
            <h3 class="text-2xl font-semibold mb-4">Chi Tiết Giỏ Hàng</h3>
            <table class="w-full table-auto" style="font-family: 'Inter', sans-serif;">
              <thead>
                <tr class="text-left border-b">
                  <th class="hidden sm:table-cell py-2">STT</th>
                  <th class="py-2">Tên Sản Phẩm</th>
                  <th class="py-2">Số lượng</th>
                  <th class="py-2">Giá</th>
                  <th class="hidden sm:table-cell py-2">Thành Tiền</th>
                  <th class="py-2"></th>
                </tr>
              </thead>
              <tbody id="cartItems" class="divide-y">
                {%for item in cartItem%}
                <tr>
                  <td class="hidden sm:table-cell"></td>
                  <td style="width: 25%;">
                      <a href="/product/{{item.id}}" class="product-name">{{item.name}}</a>
                      <img src="{{item.image_url}}" class="card-img-top border-2 w-25 mt-2 hidden sm:table-cell" alt="{{item.name}}" />
                  </td>
                  <td>
                      <div class="flex items-center">
                          <button class="btn btn-outline-primary" onclick="decrement()">-</button>
                          <input type="number" class="form-control mx-2" value="{{item.quantity}}" onchange="handleChange(this.value)" style="width: 60px; text-align: center;" min="1" />
                          <button class="btn btn-outline-primary" onclick="increment()">+</button>
                      </div>
                  </td>
                  <td>{{item.price}}</td>
                  <td class="hidden sm:table-cell">{item.quantity} * {item.price}</td>
                  <td><button class="btn btn-outline-primary" onclick="removeFromCart()">Xóa</button></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cart Summary -->
        <div class="bg-white shadow-md rounded-lg p-4">
          <h5 class="text-xl font-semibold mb-4">Tổng tiền</h5>
          <p id="totalPrice" class="text-3xl font-bold text-red-500"></p>
          <a href="/checkout" class="block w-full bg-red-500 text-white text-center py-2 rounded mt-4 hover:bg-red-600">Mua hàng</a>
        </div>
      </div>
    </div>
  </div>
  {% include 'partials/footer.html' %}

  <script>
    document.addEventListener("DOMContentLoaded", function() {
        //const apiUrl = '/api/cart-items/'; // URL của API giỏ hàng

        // const fetchCart = async () => {
        //     try {
        //         const response = await fetch(apiUrl);
        //         const data = await response.json();
        //         return data;
        //     } catch (error) {
        //         console.error('Error fetching cart:', error);
        //     }
        // };

        // const renderCart = (cart) => {
        //     const cartItemsContainer = document.getElementById('cartItems');
        //     cartItemsContainer.innerHTML = '';

        //     cart.forEach((item, index) => {
        //         const row = `
                    // <tr>
                    //     <td class="hidden sm:table-cell">${index + 1}</td>
                    //     <td style="width: 25%;">
                    //         <a href="/product/${item.product.id}" class="product-name">${item.product.name}</a>
                    //         <img src="${item.product.image_url}" class="card-img-top border-2 w-25 mt-2 hidden sm:table-cell" alt="${item.product.name}" />
                    //     </td>
                    //     <td>
                    //         <div class="flex items-center">
                    //             <button class="btn btn-outline-primary" onclick="decrement(${index})">-</button>
                    //             <input type="number" class="form-control mx-2" value="${item.quantity}" onchange="handleChange(${index}, this.value)" style="width: 60px; text-align: center;" min="1" />
                    //             <button class="btn btn-outline-primary" onclick="increment(${index})">+</button>
                    //         </div>
                    //     </td>
                    //     <td>${item.product.price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</td>
                    //     <td class="hidden sm:table-cell">${(item.quantity * item.product.price).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</td>
                    //     <td><button class="btn btn-outline-primary" onclick="removeFromCart(${index})">Xóa</button></td>
                    // </tr>
        //         `;
        //         cartItemsContainer.insertAdjacentHTML('beforeend', row);
        //     });

        //     document.getElementById('totalPrice').textContent = getTotal(cart).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        // };

        const removeFromCart = async (index) => {
            try {
                const item = cart[index];
                await fetch(`${apiUrl}${item.id}/`, { method: 'DELETE' });
                cart.splice(index, 1);
                renderCart(cart);
            } catch (error) {
                console.error('Error removing item:', error);
            }
        };

        const increment = async (index) => {
            cart[index].quantity++;
            await updateCart(index);
        };

        const decrement = async (index) => {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
                await updateCart(index);
            }
        };

        const handleChange = async (index, value) => {
            const quantity = parseInt(value, 10);
            if (!isNaN(quantity) && quantity > 0) {
                cart[index].quantity = quantity;
                await updateCart(index);
            }
        };

        const getTotal = (cart) => {
            return cart.reduce((total, item) => total + item.quantity * item.product.price, 0);
        };

        const updateCart = async (index) => {
            try {
                const item = cart[index];
                await fetch(`${apiUrl}${item.id}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: item.quantity }),
                });
                renderCart(cart);
            } catch (error) {
                console.error('Error updating cart:', error);
            }
        };

        const init = async () => {
            const cartData = await fetchCart();
            renderCart(cartData);
        };

        init();
    });
  </script>
{% endblock %}
